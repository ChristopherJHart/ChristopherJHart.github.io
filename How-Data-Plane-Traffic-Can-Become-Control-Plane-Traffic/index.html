<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="ICMP Redirects - How Data Plane Traffic Can Become Control Plane Traffic" /><meta property="og:locale" content="en" /><meta name="description" content="Note: If you are not familiar with the concepts of the data plane and control plane on network devices, I highly recommend reviewing my Understanding the Data, Control, and Management Planes of Network Devices post prior to reading this post. If you are not familiar with the concept of CoPP (Control Plane Policing) and how it can introduce packet loss for control plane traffic, I highly recommend reviewing my Understanding Control Plane Packet Loss due to CoPP post prior to reading this post." /><meta property="og:description" content="Note: If you are not familiar with the concepts of the data plane and control plane on network devices, I highly recommend reviewing my Understanding the Data, Control, and Management Planes of Network Devices post prior to reading this post. If you are not familiar with the concept of CoPP (Control Plane Policing) and how it can introduce packet loss for control plane traffic, I highly recommend reviewing my Understanding Control Plane Packet Loss due to CoPP post prior to reading this post." /><link rel="canonical" href="https://www.chrisjhart.com/How-Data-Plane-Traffic-Can-Become-Control-Plane-Traffic/" /><meta property="og:url" content="https://www.chrisjhart.com/How-Data-Plane-Traffic-Can-Become-Control-Plane-Traffic/" /><meta property="og:site_name" content="Christopher Hart" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-11-21T00:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="ICMP Redirects - How Data Plane Traffic Can Become Control Plane Traffic" /><meta name="twitter:site" content="@_ChrisJHart" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"Note: If you are not familiar with the concepts of the data plane and control plane on network devices, I highly recommend reviewing my Understanding the Data, Control, and Management Planes of Network Devices post prior to reading this post. If you are not familiar with the concept of CoPP (Control Plane Policing) and how it can introduce packet loss for control plane traffic, I highly recommend reviewing my Understanding Control Plane Packet Loss due to CoPP post prior to reading this post.","url":"https://www.chrisjhart.com/How-Data-Plane-Traffic-Can-Become-Control-Plane-Traffic/","@type":"BlogPosting","headline":"ICMP Redirects - How Data Plane Traffic Can Become Control Plane Traffic","dateModified":"2021-11-21T00:00:00-05:00","datePublished":"2021-11-21T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.chrisjhart.com/How-Data-Plane-Traffic-Can-Become-Control-Plane-Traffic/"},"@context":"https://schema.org"}</script><title>ICMP Redirects - How Data Plane Traffic Can Become Control Plane Traffic | Christopher Hart</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Christopher Hart"><meta name="application-name" content="Christopher Hart"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://avatars3.githubusercontent.com/u/13562529" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Christopher Hart</a></div><div class="site-subtitle font-italic">Documenting my discoveries in the IT world</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/ChristopherJHart" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/_ChrisJHart" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['christopherjhart95','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>ICMP Redirects - How Data Plane Traffic Can Become Control Plane Traffic</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>ICMP Redirects - How Data Plane Traffic Can Become Control Plane Traffic</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Christopher Hart </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Nov 21, 2021, 12:00 AM -0500" >Nov 21<i class="unloaded">2021-11-21T00:00:00-05:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2977 words">16 min read</span></div></div><div class="post-content"><blockquote><p><strong>Note</strong>: If you are not familiar with the concepts of the data plane and control plane on network devices, I highly recommend reviewing my <a href="/Understanding-Data-Control-Management-Planes/">Understanding the Data, Control, and Management Planes of Network Devices post</a> prior to reading this post. If you are not familiar with the concept of CoPP (Control Plane Policing) and how it can introduce packet loss for control plane traffic, I highly recommend reviewing my <a href="/Understanding-Control-Plane-Packet-Loss-due-to-CoPP/">Understanding Control Plane Packet Loss due to CoPP post</a> prior to reading this post.</p></blockquote><p>Network engineers often like to categorize a traffic flow as either data plane traffic, or control plane traffic. Under this framework, traffic is either data plane or control plane, it cannot be both. However, in reality, data plane traffic <em>can</em> become control plane traffic, which can cause increased latency or packet loss for the data plane traffic. In this post, we’ll explore how this is possible.</p><p>First, let’s get familiar with our topology. We have a Cisco Nexus switch connected to two traffic generators via physical interfaces Ethernet1/45 and Ethernet1/46. One traffic generator mimics a host named Host-1 with an IP address of 192.168.1.100, while the other traffic generator mimics a host named Host-2 with an IP address of 192.168.1.200.</p><p><img data-proofer-ignore data-src="/images/2021/icmp-redirects/topology.png" alt="" /></p><p>The switch has an SVI (Switched Virtual Interface) in VLAN 1 with an IP address of 192.168.1.1. This is a /24 subnet.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>Switch# show ip interface brief

IP Interface Status for VRF "default"(1)
Interface            IP Address      Interface Status
Vlan1                192.168.1.1     protocol-up/link-up/admin-up       
Switch# show running-config interface Vlan1

!Command: show running-config interface Vlan1
!Running configuration last done at: Sun Nov 21 16:53:53 2021
!Time: Sun Nov 21 16:55:06 2021

version 9.3(8) Bios:version 01.05 

interface Vlan1
  no shutdown
  ip address 192.168.1.1/24
</pre></table></code></div></div><p>Both traffic generators are connected to the switch via access switchports in VLAN 1.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>Switch# show spanning-tree vlan 1

VLAN0001
  Spanning tree enabled protocol rstp
  Root ID    Priority    32769
             Address     b08b.d00a.97f3
             This bridge is the root
             Hello Time  2  sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    32769  (priority 32768 sys-id-ext 1)
             Address     b08b.d00a.97f3
             Hello Time  2  sec  Max Age 20 sec  Forward Delay 15 sec

Interface        Role Sts Cost      Prio.Nbr Type
---------------- ---- --- --------- -------- --------------------------------
Eth1/47          Desg FWD 2         128.185  P2p 
Eth1/48          Desg FWD 2         128.189  P2p 
</pre></table></code></div></div><p>In this topology, there are two UDP traffic flows. One is from Host-1 to Host-2, and the other is from Host-2 to Host-1. Both traffic flows send a single packet per second. At the moment, there is no packet loss for either flow.</p><p><img data-proofer-ignore data-src="/images/2021/icmp-redirects/slow-traffic-no-packet-loss.jpg" alt="" /></p><p>However, if we look at latency statistics for each traffic flow, we can see that the traffic flow from Host-1 to Host-2 has significantly higher latency (~0.6 milliseconds, or 6,000 microseconds) compared to the traffic flow from Host-2 to Host-1 (~2 microseconds).</p><p><img data-proofer-ignore data-src="/images/2021/icmp-redirects/slow-traffic-high-latency.jpg" alt="" /></p><p>This particular Nexus switch is a Nexus 93180YC-FX. <a href="https://www.cisco.com/c/en/us/products/collateral/switches/nexus-9000-series-switches/datasheet-c78-742284.html">The data sheet for this switch</a> suggests that this model of switch has sub-microsecond port-to-port latency capabilities:</p><blockquote><p>“The Cisco Nexus 93180YC-FX Switch (Figure 4) is a 1RU switch with latency of less than 1 microsecond that supports 3.6 Tbps of bandwidth and 1.4 bpps.”</p></blockquote><p>The fact that the traffic flow from Host-1 to Host-2 has significantly higher latency than advertised suggests something is going on with this traffic flow. Let’s investigate further by using the <a href="https://www.cisco.com/c/en/us/support/docs/switches/nexus-9000-series-switches/213848-nexus-9000-cloud-scale-asic-tahoe-nx-o.html">Embedded Logic Analyzer Module (ELAM) troubleshooting tool</a> to dig into the ASIC’s forwarding decision for a packet within this traffic flow.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre>Switch# debug platform internal tah elam asic 0
Switch(TAH-elam)# trigger init 
Slot 1: param values: start asic 0, start slice 0, lu-a2d 1, in-select 6, out-select 0
Switch(TAH-elam-insel6)# set outer ipv4 src_ip 192.168.1.100 dst_ip 192.168.1.200
Switch(TAH-elam-insel6)# start
Switch(TAH-elam-insel6)# report
SUNDOWN1 ELAM REPORT SUMMARY
slot - 1, asic - 0, slice - 0
============================

Incoming Interface: Eth1/45
Src Idx : 0xb1, Src BD : 1
Outgoing Interface Info: dmod 1, dpid 25
Dst Idx : 0xb5, Dst BD : 1

Packet Type: IPv4

Dst MAC address: B0:8B:D0:0A:97:F3
Src MAC address: 00:00:00:00:11:11

Sup hit: 1,  Sup Idx: 3561

Dst IPv4 address: 192.168.1.200
Src IPv4 address: 192.168.1.100
Ver     =  4, DSCP    =    0, Don't Fragment = 0
Proto   = 17, TTL     =   64, More Fragments = 0
Hdr len = 20, Pkt len =  238, Checksum       = 0xf582

L4 Protocol  : 17
UDP Dst Port : 50000
UDP Src Port : 25000

Drop Info:
----------

LUA:
LUB:
LUC:
LUD:
  IP_SELF_FWD_FAIILURE
Final Drops:

vntag:
vntag_valid    : 0
vntag_vir      : 0
vntag_svif     : 0
</pre></table></code></div></div><p>This output has three important pieces of information:</p><ol><li>The <code class="language-plaintext highlighter-rouge">Dst MAC address</code> line indicates the Ethernet header of this packet is addressed to a MAC address assigned to the SVI of the switch, not the MAC address of Host-2 (0000.0000.2222) even though both hosts are (theoretically) in the same subnet.<li>The <code class="language-plaintext highlighter-rouge">SUP hit</code> line implies the ASIC is punting this packet from the data plane to the control plane.<li>The <code class="language-plaintext highlighter-rouge">IP_SELF_FWD_FAIILURE</code> [sic] flag under the <code class="language-plaintext highlighter-rouge">LUD</code> section gives us a hint as to why the switch is punting this packet from the data plane to the control plane.</ol><p>The outgoing interface information present in this output suggests that the switch will <em>eventually</em> forward the packet out of Ethernet1/46 (which can be proven through the <code class="language-plaintext highlighter-rouge">show system internal ethpm info all</code> command), but the index corresponding with the supervisor hit (which can be decoded through the <code class="language-plaintext highlighter-rouge">show system internal access-list sup-redirect-stats</code> command) suggests there’s an exception causing this packet to be punted.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>Switch# show system internal ethpm info all | include dmod=1,dpid=25
  IF_STATIC_INFO: port_name=Ethernet1/46,if_index:0x1a005a00,ltl=5964,slot=0, nxos_port=180,dmod=1,dpid=25,unit=0,queue=65535,xbar_unitbmp=0x0,ns_pid=255,slice_num=0,port_on_slice=25,src_id=50

Switch# show system internal access-list sup-redirect-stats | include 356
    3560                         FWD Drop or MTU Exception    449
</pre></table></code></div></div><p>If we review CoPP statistics on this switch with the <code class="language-plaintext highlighter-rouge">show policy-map interface control-plane</code> command, we can see that there are non-zero transmission statistics under the “copp-system-p-class-exception” class.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>Switch# show policy-map interface control-plane class copp-system-p-class-exception
Control Plane

  Service-policy  input: copp-system-p-policy-strict

    class-map copp-system-p-class-exception (match-any)
      match exception ip option
      match exception ip icmp unreachable
      match exception ipv6 option
      match exception ipv6 icmp unreachable
      set cos 1
      police cir 150 kbps , bc 32000 bytes 
      module 1 :
        transmitted 154200 bytes;
        5-minute offered rate 260 bytes/sec
        conformed 315 peak-rate bytes/sec
          at Sun Nov 21 20:32:29 2021

        dropped 0 bytes;
        5-min violate rate 0 byte/sec
        violated 0 peak-rate byte/sec
</pre></table></code></div></div><p>Finally, if we use the <a href="https://www.cisco.com/c/en/us/td/docs/switches/datacenter/nexus9000/sw/93x/troubleshooting/guide/b-cisco-nexus-9000-nx-os-troubleshooting-guide-93x/b-cisco-nexus-9000-nx-os-troubleshooting-guide-93x_chapter_010001.html#reference_EF208AE32A30415F8F172A5E417868A8">Ethanalyzer control plane packet capture tool</a> and filter it on packets sourced from or destined to 192.168.1.100 with the <code class="language-plaintext highlighter-rouge">ethanalyzer local interface inband display-filter ip.addr==192.168.1.100 limit-captured-frames 0</code> command, we see two types of packets:</p><ol><li>The UDP data plane traffic sourced from Host-1 (192.168.1.100) destined to Host-2 (192.168.1.200), which is being punted to the control plane by the switch.<li>ICMP Redirect packets sourced from the switch’s SVI (192.168.1.1) destined to Host-1 (192.168.1.100)</ol><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>Switch# ethanalyzer local interface inband display-filter ip.addr==192.168.1.100 limit-captured-frames 0
Capturing on inband
2021-11-21 20:45:27.872463 192.168.1.100 -&gt; 192.168.1.200 UDP Source port: 25000  Destination port: 50000
2021-11-21 20:45:27.872833  192.168.1.1 -&gt; 192.168.1.100 ICMP Redirect (Redirect for host)
2021-11-21 20:45:27.872895 192.168.1.100 -&gt; 192.168.1.200 UDP Source port: 25000  Destination port: 50000
2021-11-21 20:45:28.872503 192.168.1.100 -&gt; 192.168.1.200 UDP Source port: 25000  Destination port: 50000
2021-11-21 20:45:28.872938  192.168.1.1 -&gt; 192.168.1.100 ICMP Redirect (Redirect for host)
2021-11-21 20:45:28.873010 192.168.1.100 -&gt; 192.168.1.200 UDP Source port: 25000  Destination port: 50000
2021-11-21 20:45:29.872495 192.168.1.100 -&gt; 192.168.1.200 UDP Source port: 25000  Destination port: 50000
2021-11-21 20:45:29.872945  192.168.1.1 -&gt; 192.168.1.100 ICMP Redirect (Redirect for host)
2021-11-21 20:45:29.873006 192.168.1.100 -&gt; 192.168.1.200 UDP Source port: 25000  Destination port: 50000
2021-11-21 20:45:30.872495 192.168.1.100 -&gt; 192.168.1.200 UDP Source port: 25000  Destination port: 50000
2021-11-21 20:45:30.872912  192.168.1.1 -&gt; 192.168.1.100 ICMP Redirect (Redirect for host)
2021-11-21 20:45:30.872984 192.168.1.100 -&gt; 192.168.1.200 UDP Source port: 25000  Destination port: 50000

12 packets captured
Switch# 
</pre></table></code></div></div><blockquote><p><strong>Note</strong>: The above packet capture shows each UDP data plane packet twice for each ICMP Redirect message. This is because when the Ethanalyzer tool is run with the <code class="language-plaintext highlighter-rouge">inband</code> keyword, it captures packets entering or exiting the control plane. The first UDP data plane packet is shown as it enters the control plane through the supervisor’s inband interface after being punted from Ethernet1/45, while the second UDP data plane packet is shown as it exits the control plane through the supervisor’s inband interface after being forwarded by the software of the switch towards Ethernet1/46.</p></blockquote><p>It’s now clear what’s going on here. The switch is punting this traffic from the data plane to the control plane because it meets ICMP Redirect conditions. This behavior is described in more detail in <a href="https://www.cisco.com/c/en/us/support/docs/ios-nx-os-software/nx-os-software/213841-understanding-icmp-redirect-messages.html">Cisco’s Understanding ICMP Redirect Messages article</a> written by my friend and colleague Nikolay Kartashev. Recall that the data plane is designed to forward traffic going <em>through</em> the network device at high speeds with low latency. Generally speaking, the data plane is <em>not</em> designed to craft packets sourced by the network device itself - that responsibility lies with the control plane. Therefore, the data plane <em>must</em> punt this packet to the control plane so that the control plane can create an ICMP Redirect packet to be sent back towards the source of this traffic.</p><p>Thus far, the only symptom of this issue we’ve seen is high latency. However, another possible symptom you may observe as a result of this issue is packet loss. At the moment, our traffic flow is only 1 packet per second, which is very slow compared to a real traffic flow.</p><p><img data-proofer-ignore data-src="/images/2021/icmp-redirects/traffic-flow-low-speed.jpg" alt="" /></p><p>Let’s increase the speed of this traffic flow from 1 packet per second to 1,000 packets per second.</p><p><img data-proofer-ignore data-src="/images/2021/icmp-redirects/traffic-flow-high-speed.jpg" alt="" /></p><p>Now, we can see that the traffic flow from Host-1 to Host-2 has a significant amount of packet loss.</p><p><img data-proofer-ignore data-src="/images/2021/icmp-redirects/fast-traffic-packet-loss.jpg" alt="" /></p><p>If we re-check our CoPP statistics, we can now see drops under the copp-system-p-class-exception CoPP class. This is the root cause of the packet loss observed in this traffic flow.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>Switch# show policy-map interface control-plane class copp-system-p-class-exception
Control Plane

  Service-policy  input: copp-system-p-policy-strict

    class-map copp-system-p-class-exception (match-any)
      match exception ip option
      match exception ip icmp unreachable
      match exception ipv6 option
      match exception ipv6 icmp unreachable
      set cos 1
      police cir 150 kbps , bc 32000 bytes 
      module 1 :
        transmitted 892500 bytes;
        5-minute offered rate 2860 bytes/sec
        conformed 3963 peak-rate bytes/sec
          at Sun Nov 21 20:49:13 2021

        dropped 9055028 bytes;
        5-min violate rate 50305 byte/sec
        violated 50305 peak-rate byte/sec        at Sun Nov 21 20:49:13 2021
</pre></table></code></div></div><p>Ultimately, the root cause of this issue is the fact that Host-1’s subnet mask is misconfigured as a /25 (255.255.255.128), when it <em>should</em> be a /24 (255.255.255.0). Therefore, when Host-1 needs to send traffic to Host-2, it recognizes that Host-2’s IP address (192.168.1.200) is outside of the 192.168.1.0/25 subnet, so it believes it needs to send this traffic to its default gateway, which is the switch.</p><p><img data-proofer-ignore data-src="/images/2021/icmp-redirects/host-1-bad-subnet-mask.jpg" alt="" /></p><p>There are two tactics to fix this issue:</p><ol><li>Correct the subnet mask on Host-1.<li>Disable ICMP redirects on the switch with the <code class="language-plaintext highlighter-rouge">no ip redirects</code> interface configuration command under the VLAN 1 SVI.</ol><p>Theoretically, the first tactic is the “correct” solution. However, as network engineers, we rarely have direct control over the configuration of hosts connected to the network, so we will adopt the second tactic.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>Switch# configure terminal
Enter configuration commands, one per line. End with CNTL/Z.
Switch(config)# interface Vlan1
Switch(config-if)# no ip redirects
Switch(config-if)# end
Switch# show running-config interface Vlan1

!Command: show running-config interface Vlan1
!Running configuration last done at: Sun Nov 21 20:51:06 2021
!Time: Sun Nov 21 20:51:10 2021

version 9.3(8) Bios:version 01.05 

interface Vlan1
  no shutdown
  no ip redirects
  ip address 192.168.1.1/24
</pre></table></code></div></div><p>Now that we’ve applied this change, let’s verify whether we see our data plane traffic flow in the control plane using Ethanalyzer.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>Switch# ethanalyzer local interface inband display-filter ip.addr==192.168.1.100 limit-captured-frames 0
Capturing on inband

0 packets captured
Switch# 
</pre></table></code></div></div><p>This traffic isn’t showing up in the control plane - let’s clear our CoPP statistics and verify if the copp-system-p-class-exception CoPP class is transmitting or dropping any traffic.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre>Switch# clear copp statistics 
Switch# sleep 10
Switch# show policy-map interface control-plane class copp-system-p-class-exception
Control Plane

  Service-policy  input: copp-system-p-policy-strict

    class-map copp-system-p-class-exception (match-any)
      match exception ip option
      match exception ip icmp unreachable
      match exception ipv6 option
      match exception ipv6 icmp unreachable
      set cos 1
      police cir 150 kbps , bc 32000 bytes 
      module 1 :
        transmitted 0 bytes;
        5-minute offered rate 0 bytes/sec
        conformed 0 peak-rate bytes/sec

        dropped 0 bytes;
        5-min violate rate 0 byte/sec
        violated 0 peak-rate byte/sec
</pre></table></code></div></div><p>Our CoPP statistics for this class are clean. Let’s confirm with an ELAM that a packet in this traffic flow is no longer being punted from the data plane to the control plane.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre>Switch# debug platform internal tah elam asic 0
Switch(TAH-elam)# trigger init 
Slot 1: param values: start asic 0, start slice 0, lu-a2d 1, in-select 6, out-select 0
Switch(TAH-elam-insel6)# set outer ipv4 src_ip 192.168.1.100 dst_ip 192.168.1.200
Switch(TAH-elam-insel6)# start
Switch(TAH-elam-insel6)# report
SUNDOWN1 ELAM REPORT SUMMARY
slot - 1, asic - 0, slice - 0
============================

Incoming Interface: Eth1/45
Src Idx : 0xb1, Src BD : 1
Outgoing Interface Info: dmod 1, dpid 25
Dst Idx : 0xb5, Dst BD : 1

Packet Type: IPv4

Dst MAC address: B0:8B:D0:0A:97:F3
Src MAC address: 00:00:00:00:11:11

Dst IPv4 address: 192.168.1.200
Src IPv4 address: 192.168.1.100
Ver     =  4, DSCP    =    0, Don't Fragment = 0
Proto   = 17, TTL     =   64, More Fragments = 0
Hdr len = 20, Pkt len =  238, Checksum       = 0xf582

L4 Protocol  : 17
UDP Dst Port : 50000
UDP Src Port : 25000

Drop Info:
----------

LUA:
LUB:
LUC:
LUD:
Final Drops:

vntag:
vntag_valid    : 0
vntag_vir      : 0
vntag_svif     : 0
</pre></table></code></div></div><p>We don’t see a <code class="language-plaintext highlighter-rouge">SUP hit</code> line in this output, which implies the ASIC is not punting this packet. We also don’t see any flags under the <code class="language-plaintext highlighter-rouge">LUD</code> section of this output the same way we did previously. This indicates the traffic is being forwarded through the data plane at high bandwidth with low latency without any involvement from the control plane.</p><p>Let’s confirm this by reviewing the statistics for this traffic flow from the traffic generator’s perspective. We don’t see any packet loss:</p><p><img data-proofer-ignore data-src="/images/2021/icmp-redirects/fast-traffic-no-packet-loss.jpg" alt="" /></p><p>We also see low latency numbers for both traffic flows:</p><p><img data-proofer-ignore data-src="/images/2021/icmp-redirects/fast-traffic-low-latency.jpg" alt="" /></p><p>Now that we’ve investigated and resolved this issue, you may have two final lingering questions:</p><ol><li>Why did Host-1 not honor the ICMP Redirect message generated by the switch?<li>Why are ICMP Redirects enabled on network devices by default if ICMP Redirects can cause such huge latency and packet loss issues?</ol><p>I don’t have a great answer for the first question. <strong><em>In my experience</em></strong>, the overwhelming majority of hosts and network devices do not honor or modify their behavior according to incoming ICMP Redirect messages. <em>My suspicion</em> is that this is done for security - in the majority of circumstances, the host’s configured subnet mask takes precedence over incoming ICMP Redirect messages, as ICMP Redirect messages <em>could</em> be spoofed such that legitimate ICMP Redirect messages are indistinguishable from illegitimate ICMP Redirect messages.</p><p>With respect to the second question, this behavior is <a href="https://datatracker.ietf.org/doc/html/rfc1812#section-5.2.7.2">mandated by the IETF through Section 5.2.7.2 of RFC 1812 (Requirements for IP Version 4 Routers)</a>:</p><blockquote><p>Routers MUST be able to generate the Redirect for Host message (Code 1) and SHOULD be able to generate the Redirect for Type of Service and Host message (Code 3) specified in [INTERNET:8].</p></blockquote><p>This is what I like to call an “RFC MUST”, which is defined in <a href="https://datatracker.ietf.org/doc/html/rfc2119">RFC 2119 (Key words for use in RFCs to Indicate Requirement Levels)</a>. As a result, network vendors (Cisco, Juniper, Arista, Dell, HPE, etc.) <em>cannot</em> disable this behavior by default without deviating from an RFC that defines one of the fundamentals of modern-day networking, even if such behavior would be a net positive for the networking world at large. As you can imagine, if one vendor deviated from the RFC, other vendors could have a field day with this by claiming that the first vendor is not RFC compliant with IPv4 networking. From an optics perspective, that looks really bad - after all, if you heard that a specific vendor didn’t fully support basic IPv4 networking in the modern day, your first instinct would probably be to avoid that vendor at all instead of investigating specific details behind this claim!</p><p>Ultimately, this issue must be fixed through an IETF RFC that updates RFC 1812 (and the IPv6 equivalent, as I <em>believe</em> the behavior is identical with IPv6 and ICMPv6 Redirect messages).</p><h2 id="conclusion">Conclusion</h2><p>As demonstrated in this post, it is possible for data plane traffic to become control plane traffic in certain scenarios. Network devices that have some measure of control plane protection will most likely introduce increased latency or packet loss for this data plane traffic. One example scenario has to do with ICMP Redirects, although there exist other scenarios (such as ARP Gleaning) that can introduce a similar issue.</p></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=ICMP Redirects - How Data Plane Traffic Can Become Control Plane Traffic - Christopher Hart&url=https://www.chrisjhart.com/How-Data-Plane-Traffic-Can-Become-Control-Plane-Traffic/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=ICMP Redirects - How Data Plane Traffic Can Become Control Plane Traffic - Christopher Hart&u=https://www.chrisjhart.com/How-Data-Plane-Traffic-Can-Become-Control-Plane-Traffic/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=ICMP Redirects - How Data Plane Traffic Can Become Control Plane Traffic - Christopher Hart&url=https://www.chrisjhart.com/How-Data-Plane-Traffic-Can-Become-Control-Plane-Traffic/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/Windows-10-ssh-copy-id/">Windows 10 OpenSSH Equivalent of ssh-copy-id</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/Understanding-Control-Plane-Packet-Loss-due-to-CoPP/"><div class="card-body"> <span class="timeago small" >Nov 13<i class="unloaded">2021-11-13T00:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Understanding Control Plane Packet Loss due to CoPP</h3><div class="text-muted small"><p> Note: If you are not familiar with the concepts of the data plane and control plane on network devices, I highly recommend reviewing my Understanding the Data, Control, and Management Planes of ...</p></div></div></a></div><div class="card"> <a href="/Understanding-Data-Control-Management-Planes/"><div class="card-body"> <span class="timeago small" >Nov 12<i class="unloaded">2021-11-12T00:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Understanding the Data, Control, and Management Planes of Network Devices</h3><div class="text-muted small"><p> While troubleshooting connectivity issues and packet loss in computer networks, network engineers often misunderstand the difference between the data plane and control plane. This can lead to fault...</p></div></div></a></div><div class="card"> <a href="/Understanding-Load-Balancing/"><div class="card-body"> <span class="timeago small" >Oct 24<i class="unloaded">2021-10-24T00:00:00-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Understanding Load Balancing on Network Devices</h3><div class="text-muted small"><p> A common misunderstanding engineers have about Equal-Cost Multi-Pathing (ECMP) and port-channels is that they increase the bandwidth that can be used between two network devices. This can be true, ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/Understanding-Control-Plane-Packet-Loss-due-to-CoPP/" class="btn btn-outline-primary" prompt="Older"><p>Understanding Control Plane Packet Loss due to CoPP</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/_ChrisJHart">Christopher Hart</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script>
